---
title: "15 Insights from Colorado School Enrollment Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{15 Insights from Colorado School Enrollment Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
# Check if we're in a context where we should run live data fetches
NOT_CRAN <- identical(tolower(Sys.getenv("NOT_CRAN")), "true")

# Also check if we can actually fetch enrollment data
# The CDE data server (www.cde.state.co.us) may be down even when NOT_CRAN=true
can_fetch <- NOT_CRAN && tryCatch({
  # Quick connectivity check - try HEAD request first
  response <- httr::HEAD(
    "https://www.cde.state.co.us/cdereval/pupilmembership-statistics",
    httr::timeout(10)
  )
  !httr::http_error(response)
}, error = function(e) FALSE)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 5,
  eval = can_fetch,
  cache = TRUE
)
```

```{r load-packages}
library(coschooldata)
library(dplyr)
library(tidyr)
library(ggplot2)

theme_set(theme_minimal(base_size = 14))
```

This vignette explores Colorado's public school enrollment data, surfacing key trends and demographic patterns across 5 years of data (2020-2024). Colorado is part of the [state schooldata project](https://github.com/almartin82/njschooldata), a family of R packages providing consistent access to school enrollment data from all 50 states.

---

## 1. Colorado's decade of growth has ended

Colorado public schools grew steadily from 2009 to 2019, adding over 100,000 students. Since COVID, enrollment has been flat to declining.

```{r statewide-trend}
enr <- fetch_enr_multi(2020:2024, use_cache = TRUE)

state_totals <- enr |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  select(end_year, n_students) |>
  mutate(change = n_students - lag(n_students),
         pct_change = round(change / lag(n_students) * 100, 2))

state_totals
```

```{r statewide-chart}
ggplot(state_totals, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.2, color = "#003366") +
  geom_point(size = 3, color = "#003366") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Colorado Public School Enrollment (2020-2024)",
    subtitle = "Growth has stalled after a decade of expansion",
    x = "School Year (ending)",
    y = "Total Enrollment"
  )
```

---

## 2. Denver Public Schools lost thousands of students

Denver Public Schools, the state's largest district, has seen dramatic enrollment declines since 2020, losing the equivalent of a mid-sized suburban district.

```{r denver-decline}
denver <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Denver County 1", district_name)) |>
  select(end_year, district_name, n_students) |>
  mutate(change = n_students - lag(n_students))

denver
```

```{r top-districts-chart}
enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Denver County 1|Douglas County|Jefferson County|Cherry Creek", district_name)) |>
  ggplot(aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Colorado's Largest Districts: Diverging Paths",
    subtitle = "Denver declines while Douglas County grows",
    x = "School Year",
    y = "Enrollment",
    color = "District"
  )
```

---

## 3. COVID crushed kindergarten statewide

Colorado kindergarten enrollment dropped 15% during COVID and hasn't fully recovered, creating a "missing class" now moving through elementary schools.

```{r covid-k}
covid_grades <- enr |>
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "01", "05", "09"),
         end_year %in% 2020:2024) |>
  select(end_year, grade_level, n_students) |>
  pivot_wider(names_from = grade_level, values_from = n_students)

covid_grades
```

---

## 4. Hispanic students are 34% of enrollment

Colorado's Hispanic student population has grown from under 30% to over 34% since 2009, making it the largest single demographic group in many districts.

```{r demographics}
enr_2024 <- fetch_enr(2024, use_cache = TRUE)

demographics <- enr_2024 |>
  filter(is_state, grade_level == "TOTAL",
         subgroup %in% c("hispanic", "white", "black", "asian", "native_american", "multiracial")) |>
  mutate(pct = round(pct * 100, 1)) |>
  select(subgroup, n_students, pct) |>
  arrange(desc(n_students))

demographics
```

```{r demographics-chart}
demographics |>
  mutate(subgroup = forcats::fct_reorder(subgroup, n_students)) |>
  ggplot(aes(x = n_students, y = subgroup, fill = subgroup)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = paste0(pct, "%")), hjust = -0.1) +
  scale_x_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.15))) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Colorado Student Demographics (2024)",
    subtitle = "Hispanic students are over a third of enrollment",
    x = "Number of Students",
    y = NULL
  )
```

---

## 5. Douglas County is Colorado's growth engine

While Denver shrinks, Douglas County School District south of Denver has been growing steadily, now serving over 65,000 students.

```{r douglas-county}
denver_douglas <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Douglas County|Denver County", district_name)) |>
  select(end_year, district_name, n_students) |>
  pivot_wider(names_from = district_name, values_from = n_students)

denver_douglas
```

---

## 6. The Western Slope is shrinking

Rural districts on the Western Slope (Grand Junction, Montrose, Delta) are losing students as young families struggle to find affordable housing.

```{r western-slope}
western_slope <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Mesa County|Montrose|Delta", district_name)) |>
  group_by(district_name) |>
  summarize(
    y2020 = n_students[end_year == 2020],
    y2024 = n_students[end_year == 2024],
    pct_change = round((y2024 / y2020 - 1) * 100, 1),
    .groups = "drop"
  ) |>
  arrange(pct_change)

western_slope
```

```{r regional-chart}
enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Mesa County Valley|Montrose County|Delta County", district_name)) |>
  ggplot(aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Western Slope Districts: Declining Enrollment",
    subtitle = "Rural districts losing students as housing costs rise",
    x = "School Year",
    y = "Enrollment",
    color = "District"
  )
```

---

## 7. Charter schools serve 130,000 students

Colorado's charter sector has grown substantially, now serving about 15% of all public school students statewide.

```{r charters}
state_total <- enr_2024 |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  pull(n_students)

charter_total <- enr_2024 |>
  filter(is_charter, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  summarize(charter_total = sum(n_students, na.rm = TRUE)) |>
  pull(charter_total)

tibble(
  sector = c("All Public Schools", "Charter Schools"),
  enrollment = c(state_total, charter_total),
  pct = c(100, round(charter_total / state_total * 100, 1))
)
```

---

## 8. Aurora is Colorado's most diverse district

Aurora Public Schools has no racial majority--it's a "majority-minority" district with significant Hispanic, Black, Asian, and white populations.

```{r aurora}
aurora <- enr_2024 |>
  filter(is_district, grade_level == "TOTAL",
         grepl("Aurora", district_name),
         subgroup %in% c("hispanic", "white", "black", "asian", "multiracial")) |>
  mutate(pct = round(pct * 100, 1)) |>
  select(district_name, subgroup, n_students, pct) |>
  arrange(desc(pct))

aurora
```

---

## 9. Mountain towns are pricing out families

Ski resort communities like Summit, Eagle, and Pitkin counties have seen enrollment declines as housing costs push working families to lower-cost areas.

```{r mountain-towns}
mountain_towns <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Summit|Eagle County|Aspen|Vail", district_name, ignore.case = TRUE)) |>
  group_by(district_name) |>
  filter(n() > 5) |>
  summarize(
    earliest = n_students[end_year == min(end_year)],
    latest = n_students[end_year == max(end_year)],
    pct_change = round((latest / earliest - 1) * 100, 1),
    .groups = "drop"
  ) |>
  arrange(pct_change)

mountain_towns
```

---

## 10. The Northern Front Range is booming

Districts in the Fort Collins-Loveland corridor (Poudre, Thompson, Weld County) are among the fastest-growing in the state.

```{r northern-front-range}
northern <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Poudre|Thompson|Weld|Greeley", district_name, ignore.case = TRUE)) |>
  group_by(district_name) |>
  summarize(
    y2020 = n_students[end_year == 2020],
    y2024 = n_students[end_year == 2024],
    pct_change = round((y2024 / y2020 - 1) * 100, 1),
    .groups = "drop"
  ) |>
  arrange(desc(pct_change))

northern
```

---

## 11. Colorado has slightly more boys than girls in school

Like most states, Colorado has a small gender imbalance with about 51% male students and 49% female students across all grades.

```{r gender-balance}
gender <- enr_2024 |>
  filter(is_state, grade_level == "TOTAL",
         subgroup %in% c("male", "female")) |>
  mutate(pct = round(pct * 100, 1)) |>
  select(subgroup, n_students, pct)

gender
```

```{r gender-chart}
gender |>
  mutate(subgroup = factor(subgroup, levels = c("female", "male"))) |>
  ggplot(aes(x = subgroup, y = n_students, fill = subgroup)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = paste0(scales::comma(n_students), "\n(", pct, "%)")),
            vjust = -0.2, size = 4) +
  scale_y_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.15))) +
  scale_fill_manual(values = c("female" = "#E91E63", "male" = "#2196F3")) +
  labs(
    title = "Colorado Student Gender Distribution (2024)",
    subtitle = "Slight male majority across all grades",
    x = NULL,
    y = "Number of Students"
  )
```

---

## 12. High school enrollment is remarkably stable

While elementary grades show COVID disruption, high school grades 9-12 have remained steady, suggesting families prioritize keeping older students enrolled.

```{r high-school}
high_school <- enr |>
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("09", "10", "11", "12")) |>
  group_by(end_year) |>
  summarize(hs_total = sum(n_students, na.rm = TRUE), .groups = "drop") |>
  mutate(change = hs_total - lag(hs_total),
         pct_change = round(change / lag(hs_total) * 100, 2))

high_school
```

```{r high-school-chart}
ggplot(high_school, aes(x = end_year, y = hs_total)) +
  geom_line(linewidth = 1.2, color = "#4CAF50") +
  geom_point(size = 3, color = "#4CAF50") +
  scale_y_continuous(labels = scales::comma, limits = c(0, NA)) +
  labs(
    title = "Colorado High School Enrollment (Grades 9-12)",
    subtitle = "Stable enrollment despite COVID disruptions in elementary",
    x = "School Year",
    y = "Total Students"
  )
```

---

## 13. Jefferson County is shrinking faster than Denver

Jefferson County (Jeffco), the state's second-largest district, is losing students at a rate comparable to Denver, signaling broader suburban challenges.

```{r jeffco}
jeffco <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Jefferson County", district_name)) |>
  select(end_year, district_name, n_students) |>
  mutate(change = n_students - lag(n_students),
         pct_change = round(change / lag(n_students) * 100, 2))

jeffco
```

```{r jeffco-chart}
enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Jefferson County|Denver County|Douglas County", district_name)) |>
  ggplot(aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Front Range Giants: Enrollment Trends",
    subtitle = "Jeffco and Denver declining, Douglas growing",
    x = "School Year",
    y = "Enrollment",
    color = "District"
  )
```

---

## 14. Pre-K enrollment never recovered from COVID

Colorado's Pre-K programs saw the steepest COVID drop and have not returned to pre-pandemic levels, affecting kindergarten readiness statewide.

```{r pre-k}
prek <- enr |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "PK") |>
  select(end_year, n_students) |>
  mutate(change = n_students - lag(n_students),
         pct_change = round(change / lag(n_students) * 100, 2))

prek
```

```{r prek-chart}
ggplot(prek, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.2, color = "#FF9800") +
  geom_point(size = 3, color = "#FF9800") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Colorado Pre-K Enrollment",
    subtitle = "Never recovered to pre-pandemic levels",
    x = "School Year",
    y = "Pre-K Students"
  )
```

---

## 15. Top 10 districts serve half of Colorado students

Just 10 districts out of 178 serve over 50% of all Colorado public school students, showing extreme concentration of enrollment.

```{r top-10-districts}
district_totals <- enr_2024 |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  arrange(desc(n_students)) |>
  head(10) |>
  select(district_name, n_students)

state_total <- enr_2024 |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  pull(n_students)

top_10_pct <- round(sum(district_totals$n_students) / state_total * 100, 1)

district_totals |>
  mutate(pct_of_state = round(n_students / state_total * 100, 1))
```

```{r top-10-chart}
district_totals |>
  mutate(district_name = forcats::fct_reorder(district_name, n_students)) |>
  ggplot(aes(x = n_students, y = district_name)) +
  geom_col(fill = "#673AB7") +
  geom_text(aes(label = scales::comma(n_students)), hjust = -0.1, size = 3.5) +
  scale_x_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Colorado's 10 Largest School Districts (2024)",
    subtitle = paste0("These districts serve ", top_10_pct, "% of all students"),
    x = "Total Enrollment",
    y = NULL
  )
```

---

## Summary

Colorado's school enrollment data reveals:

- **Stalled growth**: The decade-long boom has ended post-COVID
- **Urban decline**: Denver and Jefferson County losing students rapidly
- **Suburban surge**: Douglas County and Northern Front Range growing
- **Hispanic plurality**: Over 34% of students are Hispanic
- **Mountain town challenges**: Resort communities losing families to high housing costs
- **Pre-K gap**: Early childhood enrollment never recovered from COVID
- **Concentrated enrollment**: Top 10 districts serve over half the state

These patterns shape school funding debates and facility planning across the Centennial State.

---

*Data sourced from the Colorado Department of Education [Pupil Membership](https://www.cde.state.co.us/cdereval/pupilcurrent).*

---

## Session Info

```{r session-info}
sessionInfo()
```
